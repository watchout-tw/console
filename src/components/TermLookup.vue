<template>
<div class="term-lookup">
  <el-date-picker :placeholder="config.label" v-model="tmp" @change="handleChange()"></el-date-picker>
</div>
</template>

<script>
import * as api from '@/util/api'

export default {
  props: ['value', 'uuid', 'cascadeThis', 'config', 'page'],
  data() {
    return {
      tmp: undefined
    }
  },
  watch: {
    'value'() {
      this.syncModel()
    }
  },
  methods: {
    syncModel() {
      this.tmp = this.value
    },
    handleChange() {
      this.$emit('update:value', this.tmp)

      if(this.config.cascadeUpdate) {
        let uploadObj = {
          fromID: this.uuid
        }
        if(this.tmp.constructor.name === 'Date') {
          let timestamp = this.tmp.getTime()
          api.lookupTerm({
            timestamp
          }).then(response => {
            if(response.data.term_index) {
              uploadObj.value = response.data
            } else {
              this.$message({
                message: this.tmp.toLocaleDateString() + '是休會期間',
                type: 'error'
              })
              this.tmp = undefined
            }
            this.$emit('update:cascadeThis', uploadObj)
          })
        } else {
          this.$emit('update:cascadeThis', uploadObj)
        }
      }
    }
  }
}
</script>
